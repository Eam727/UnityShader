
# **渲染管线-光栅化阶段**

参考自：Unity Shader入门精要，本文为本人 学习笔记，请读者尊重原著版权，多多支持冯乐乐前辈的著作。

这两个阶段，开发者没有绝对的控制权(但GPU向开发者开放了很多控制权)，其实现的载体是GPU。

![GPU流水线](https://i.imgur.com/KzyFDns.png)

## 光栅化阶段

### - 三角形设置

从上一个阶段输出的信息是**屏幕坐标系下的顶点位置以及和它们相关的额外信息，如深度值(z坐标)、法线方向、视角方向等**。

光栅化阶段有两个最重要的目标：**计算每个图元覆盖哪些像素，以及为这个像素计算它们的颜色**。

三角形设置阶段会**计算光栅化一个三角网格所需的信息**。具体来说，上阶段输出的都是三角网格的顶点，即我们得到的是三角网格每条边的两个端点。但如果要得到整个三角网格对像素的覆盖情况，我们就必须计算每条边上的像素坐标。为了能够计算边界像素的坐标信息，我们就需要得到三角形边界的表示方式。这样一个**计算三角网格表示数据的过程就叫做三角形设置**。他的输出是为了给下一个阶段做准备。

### - 三角形遍历

这阶段会**检查每个像素是否被一个三角网格所覆盖**。如果被覆盖的话，就会生成一个*片元*
(fragment)。
而这样一个找到哪些像素被三角网格覆盖的过程就是三角形遍历，这个阶段也被称为**扫描变换**。

这阶段会根据上阶段的计算结果来判断一个三角网格覆盖了哪些像素，并使用三角网格3个顶点的顶点信息对整个覆盖区域的像素进行插值。下图暂时了这个阶段的简化计算过程。

![](https://i.imgur.com/WdldzNA.png)

这一步的输出就是得到一个**片元序列**。需要注意的是，*一个**片元**并不是真正意义上的像素，而是包含了很多状态的集合，这些状态用于计算每个像素的最终颜色，这些状态包括但不限于他的屏幕坐标、深度信息，以及其他从几何阶段输出的顶点信息，例如发现、纹理坐标等*。

### - 片元着色器[可编程]

在DirectX中，片元着色器被称为像素着色器(Pixel Shader),但片元着色器是一个更合适的名字，因为此时的片元并不是一个真正意义上的像素。

前面的光栅化阶段实际上并不会影响屏幕上每个像素的颜色值，而是会产生一系列的数据信息，用来表述一个三角形网格是怎样覆盖每个像素的。而每个片元就负责存储这样一系列数据。真正会对像素产生影响的结算是下一阶段--逐片元操作。

片元着色器的输入是上阶段对顶点信息插值得到的结果，更具体来说，是根据那些从顶点着色器中输出的数据插值得到的。而它的输出是一个或者多个颜色值。下图显示了这样一个过程。

这一阶段可以完成很多重要的渲染技术，其中最终的技术之一是**纹理采样**。为了在片元着色器中进行纹理采样，我们通常会**在顶点着色器阶段输出每个顶点对应的纹理坐标，然后经过光栅化阶段对三角网格的3个顶点对应的纹理坐标进行插值后**，就可以得到其覆盖的片元的纹理坐标了。

![](https://i.imgur.com/Zk9RsUi.png)

虽然片元着色器可以完成很多重要效果，但它的局限在于，它仅可以影响单个片元。也就是说，当执行片元着色器时，它不可以将自己的任何结果直接发给它的邻居们。有一个情况例外，就是片元着色器可以访问到导数信息。

### - 逐片元操作(Per-Fragment Operations)[不可编程,高可配置]
	
负责执行很多重要的操作，例如**修改颜色、深度缓冲、进行混合**等。
逐片元操作是OpenGL的说法，在DirectX中，这一阶段被称为**输出合并阶段**(Output-Merger)。Merger这个词可能更容易让读者明白这一步骤的目的：合并。而OpenGL中的名字可以让读者明白这个阶段的操作单位，即是对每一个片元进行一些操作。

**这一阶段有几个主要任务：**

- 决定每个片元的可见性。这涉及了很多测试工作，例如深度测试、模版测试等。
- 如果一个片元通过了所有的测试，就需要把这个片元的颜色值和已经存储在颜色缓冲区中的颜色进行合并，或者说混合。

需要指明的是，逐片元操作阶段是高度可配置的，即我们可以设置每一步的操作细节。

这个阶段首先需要解决每个片元的可见性问题。这需要进行一系列测试。这就好比考试，一个片元只有通过了所有的考试，才能最终获得和GPU谈判的资格，这个资格指的是他可以和颜色缓冲区进行合并。如果它没有通过其中的某一个测试，那么之前为了产生这个片元所做的所有工作都是白费的，这个片元会被舍弃掉。下图给出了简化后的逐片元操作所做的操作。

![](https://i.imgur.com/38g7obx.png)

测试的过程实际上是一个比较复杂的过程，而且不同的图形接口的实现细节也不尽相同。这里给出两个最基本的测试--深度测试和模版测试的实现过程。

![](https://i.imgur.com/npIinBL.png)

![](https://i.imgur.com/dPmMAdf.png)
![](https://i.imgur.com/Ht2RJJH.png)

![](https://i.imgur.com/bdSjVWM.png)

![](https://i.imgur.com/Egb3P0X.png)